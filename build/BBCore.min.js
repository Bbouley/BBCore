/*! BBCore 2015-02-05 */
function BBCore(a){this.userEmail="",this.userId="",this.clientId="",this.accessToken="",this.currentVideoId=null,this.email=null,this.apiServer=null,this.onerror=null;for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.authenticated=!1,this.hasContext=!1,this.storage=localStorage||window.storage,this.CONTENT={QUICKSEND:""},this.lastresponse="",this.__vidRecording=!1,this.__vidRecHndl=null,this.recording=function(a){this.vid_id="",this.title="",this.filename="",$.extend({},this,a)},this.contact=function(a){this.email="",this.firstname="",this.lastname="",this.phone="",this.phone_number="",this.address_line_1="",this.address_line_2="",this.city="",this.state="",this.country="",this.postal_code="",this.company="",this.position="",this.comments="",this.listlist="",this.id="";for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.eml=this.email},this.contacts=function(){},this.contacts.prototype=Array.prototype,this.contacts.constructor=this.contacts,this.contacts.prototype.add=function(a){return this.push(a),this},this.contacts.prototype.find=function(a,b){for(var c in this)if(this.hasOwnProperty(c)&&c[a]===b)return c;return null},this.contacts.prototype.get=function(a){return this.findContact("id",a)},this.video=function(a){this.vid_id="",this.title="",this.filename="";for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])},this.videos=function(){},this.videos.prototype=Array.prototype,this.videos.constructor=this.videos,this.videos.prototype.add=function(a){return this.push(a),this},this.accessToken&&this.validateAccessToken(),this.email&&this.password&&this.login(this.email,this.password)}BBCore.CONFIG={VERSION:"1.0",API_END_POINT:"/app/api/api.php",SERVER_API_URL:"https://app.bombbomb.com"},BBCore.prototype.__updateSession=function(a,b){"success"===a.status?(this.userId=a.info.user_id,this.clientId=a.info.client_id,this.accessToken=a.info.api_key,this.hasContext=!0,this.authenticated=!0,this.storeKey(this.accessToken),console.log("bbcore: __updateSession session updated."),b&&b.call(this,a)):alert(a.status+" occurred while trying to login.")},BBCore.prototype.onError=function(a,b){"function"==typeof a?this.onerror=a:this.onerror&&this.onerror.call(this,a,b)},BBCore.prototype.login=function(a,b,c){if("function"==typeof a&&(c=a,a=this.storage.getItem("b2-uid"),b=this.storage.getItem("b2-pwd")),a){this.userEmail=a;var d=this;this.sendRequest({method:"ValidateSession",email:a,pw:b},function(a){d.__updateSession(a,c)})}},BBCore.prototype.logout=function(){this.storage.removeItem("b2-uid"),this.storage.removeItem("b2-pwd"),this.storage.removeItem("access_token"),this.hasContext=!1,this.authenticated=!1},BBCore.prototype.credentialsSaved=function(){return null!==this.storage.getItem("b2-uid")?null!==this.storage.getItem("b2-uid"):this.storage.getItem("access_token")},BBCore.prototype.saveCredentials=function(a,b){this.storage.setItem("b2-uid",a),this.storage.setItem("b2-pwd",b)},BBCore.prototype.resumeStoredSession=function(a,b){this.accessToken=window.storage.getItem("access_token"),this.accessToken?this.validateAccessToken(a):window.storage.getItem("b2-uid")?this.login(a):b()},BBCore.prototype.validateAccessToken=function(a){var b=this;this.sendRequest({method:"ValidateSession",api_key:this.accessToken,async:!1},function(c){b.__updateSession(c,a)})},BBCore.prototype.isAuthenticated=function(){return this.authenticated||console.log("You must authenticate a BombBomb session before making additional calls."),this.authenticated},BBCore.prototype.invalidateSession=function(){var a=this;this.sendRequest({method:"invalidateKey"},function(){a.accessToken="",a.authenticated=!1,a.hasContext=!1})},BBCore.prototype.getServerUrl=function(){return this.apiServer||BBCore.CONFIG.SERVER_API_URL},BBCore.prototype.getRequestUrl=function(){return this.getServerUrl()+BBCore.CONFIG.API_END_POINT},BBCore.prototype.sendRequest=function(a,b,c,d){if("function"==typeof b&&(c=b),"object"==typeof a&&(b=a),"object"==typeof a&&b.method&&(a=b.method),"IsValidLogin"===a||b.api_key||(b.api_key=this.accessToken),"ValidateSession"!==a&&!this.authenticated)return this.onError.call(this,{status:"failure",methodName:"InvalidSession",info:{errormsg:"Invalid login"}},null),!1;var e=this,f=!0;return"undefined"!=typeof b.async&&(f=b.async),$.ajax({url:b.url?b.url:this.getRequestUrl(),async:f,type:"post",dataType:"json",crossDomain:!0,data:b,success:function(b){e.lastresponse=b.status,"success"===b.status?("GetVideoGuid"===a&&b.info&&b.info.video_id&&(this.currentVideoId=b.info.video_id),c&&c.call(e,b)):e.onError.call(e,b)},error:function(a){var b={status:"unknown",jqXHR:a};"undefined"!=typeof a.responseJSON&&(b=a.responseJSON),e.lastresponse=b.status,"success"===b.status?c.call(e,b,a):e.onError.call(e,b,a),d&&d(e,b)}})},BBCore.prototype.verifyKey=function(a,b){this.sendRequest({method:"GetEmails",api_key:a},function(a){b||b({isValid:"success"===a.status})})},BBCore.prototype.storeKey=function(a){this.accessToken&&(this.accessToken=a),this.accessToken&&this.storage.setItem("access_token",this.accessToken)},BBCore.prototype.getKey=function(){return this.accessToken},BBCore.prototype.saveRecording=function(a){var b=a;b.vid_id&&this.sendRequest({method:"VideoRecordedLive"},b,function(){})},BBCore.prototype.setVideoId=function(a){this.currentVideoId=a},BBCore.prototype.getVideoId=function(a){this.currentVideoId?a&&a.call(this,this.currentVideoId):this.getNewVideoGuid(a)},BBCore.prototype.hasVideoId=function(){return this.currentVideoId},BBCore.prototype.getNewVideoGuid=function(a){var b=this;this.sendRequest({method:"GetVideoGuid"},function(c){b.currentVideoId=c.info.video_id,a&&a.call(this,b.currentVideoId)})},BBCore.prototype.videoQuickSend=function(a,b){var c={method:"VideoQuickSend",subject:"QuickSend from BombBomb",mobile_message:"",email_address:null,videoId:null},d=[];for(var e in c)a[e]||(a[e]=c[e]);a.message&&!a.mobile_message&&(a.mobile_message=a.message),a.email&&!a.email_address&&(a.email_address=a.email),a.email_address&&!a.email_addresses&&(a.email_addresses=a.email_address),!a.video_id&&this.currentVideoId&&(a.video_id=this.currentVideoId),a.video_id||d.push("quickSendVideo Error: no video_id defined."),a.subject||d.push("quickSendVideo Error: no subject defined."),a.email_addresses||d.push("quickSendVideo Error: no email_address defined."),d.length>0&&!a.video_id?this.getVideoId(function(c){c?(a.video_id=c,this.sendRequest(a,b)):(d.push("quickSendVideo: Terminal Error: Unable to set video_id"),this.onError({info:{errmsg:d}}))}):this.sendRequest(a,b)},BBCore.prototype.getEmbeddedRecorderUrl=function(a,b){"function"==typeof a&&(b=a);var c={height:240,width:340,force_ssl:!1};"undefined"==typeof a.height&&(a=c);var d=$.extend({},a,{module:"videos",page:"EmbeddedRecorder",popup:1,nohtml:1,api_key:this.getKey()}),e=this;this.getVideoId(function(a){var c=e.getServerUrl()+"/app/?module=login&actn=login&api_key="+e.getKey()+"&redir="+btoa(e.getServerUrl()+"/app/?"+$.param(d)+(a?"&vguid="+a:""));b.call(this,{url:c,video_id:a})})},BBCore.prototype.getVideoRecorder=function(a,b){"function"==typeof a&&(b=a,a=null);var c={height:240,width:340,force_ssl:!1,start:null,stop:null,recorded:null};return a=a||{},$.extend(a,c),this.isAuthenticated()?(a.method="GetVideoRecorder",void this.sendRequest(a,function(a){console.log("GetVideoRecorder returned, calling callback"),console.log(b),b&&b.call(this,a)})):void this.onError({message:"Must authenticate session before invoking methods."})},BBCore.prototype.startVideoRecorder=function(a,b){"function"==typeof a&&(b=a,a=null);var c={type:"embedded",target:null,height:240,width:340,force_ssl:!1,recorderLoaded:null,recordComplete:b};a=a||c,a.recordComplete&&!b&&(b=a.recordComplete),this.__vidRecHndl=a.target?$(a.target):$("body").append('<div id="b2recorder"></div>');var d=a;delete d.type,delete d.target,delete d.recordComplete,delete d.recorderLoaded;var e=this;this.getVideoRecorder(d,function(b){!e.currentVideoId&&b.info.vid_id&&(e.currentVideoId=b.info.vid_id),console.log("startVideoRecorder :"+e.currentVideoId),e.__vidRecHndl.html(b.info.content),a.recorderLoaded&&a.recorderLoaded.call(e,b.info)}),window.bbStreamStartRecord=function(a,b){console.log("bbStreamStartRecord triggered"),e.liveStreamStartRecord.call(e,a,b)},window.bbStreamStopRecord=function(a){console.log("bbStreamStopRecord triggered"),e.liveStreamStopRecord.call(e,a)},window.reportVideoRecorded=function(a,c){console.log("reportVideoRecorded triggered"),b({videoId:e.currentVideoId,filename:a,log:c})}},BBCore.prototype.destroyVideoRecorder=function(){"undefined"!=typeof this.__vidRecHndl&&this.__vidRecHndl.remove(),window.bbStreamStartRecord=null,window.bbStreamStopRecord=null,window.reportVideoRecorded=null},BBCore.prototype.liveStreamStartRecord=function(a,b){this.__vidRecording=!0,this.sendRequest({method:"liveStreamStartRecord",streamname:a,filename:b})},BBCore.prototype.liveStreamStopRecord=function(a){this.__vidRecording=!1,this.sendRequest({method:"liveStreamStopRecord",streamname:a})},BBCore.prototype.getVideoDeliveryUrl=function(a){a=$.extend({video_id:"",autoplay:1},a);var b=this.getServerUrl().indexOf("dev")>0?"dev.":this.getServerUrl().indexOf("local")>0?"local.":"";return"http://"+b+"bbemaildelivery.com/bbext/?p=video_land&id="+a.video_id+"&autoplay="+a.autoplay},BBCore.prototype.saveRecordedVideo=function(a,b,c,d){var e=b||this.currentVideoId,f=this;this.sendRequest({method:"VideoRecordedLive",title:a,filename:c,vid_id:e},function(a){d.call(f,a)})},BBCore.prototype.getVideo=function(a,b){a&&this.sendRequest({method:"GetVideos",video_id:a},b)},BBCore.prototype.getVideos=function(a,b){var c={updatedSince:"",page:"",pageSize:""};"function"==typeof a&&(b=a,a={});var d=$.extend({},c,a);d.method="GetVideos",(d.page.length||d.page>0)&&(d.method="GetVideosPaged"),this.sendRequest(d,b)},BBCore.prototype.getVideoStatus=function(a,b){a&&this.sendRequest({method:"getVideoStatus",id:a},b)},BBCore.prototype.getEncodingReport=function(a,b){a&&this.sendRequest({method:"getEncodingReport",id:a},b)},BBCore.prototype.deleteVideo=function(a,b){this.sendRequest({method:"DeleteVideo",video_id:a},b)},BBCore.prototype.getLists=function(a){this.sendRequest({method:"GetLists"},a)},BBCore.prototype.createList=function(a,b){this.sendRequest({method:"createList",name:a},b)},BBCore.prototype.getEmails=function(a){this.sendRequest({method:"GetEmails"},a)},BBCore.prototype.getContact=function(a,b){if(a){var c={width:340,force_ssl:!1},d=$.extend({},c,{contact_id:a,method:"GetContact"});this.sendRequest(d,b)}},BBCore.prototype.getListContacts=function(a,b){a&&this.sendRequest({method:"GetListContacts",list_id:a},b)},BBCore.prototype.addContact=function(a,b){"object"==typeof a&&this.sendRequest({method:"AddContact",contact:a},b)},BBCore.prototype.bulkAddContacts=function(a,b){"undefined"==typeof a&&(a={}),a.method="BulkAddContacts","object"==typeof a.contacts&&(a.contacts=JSON.stringify(a.contacts)),this.sendRequest(a,b)},BBCore.prototype.updateContact=function(a,b){a=a||{},a.method="UpdateContact",this.sendRequest(a,b)},BBCore.prototype.getDrips=function(a,b){a=a||{},a.method="GetDrips",this.sendRequest(a,b)},BBCore.prototype.getForms=function(a,b){a=a||{},a.method="GetForms",this.sendRequest(a,b)},BBCore.prototype.getImportAddressesByType=function(a,b){a=$.extend({method:"getImportAddressesByType"},a),a.type||this.onError({info:{errmsg:["A Type must be provided."]}}),this.sendRequest(a,b)},BBCore.prototype.addContactImportAddress=function(a,b){a=$.extend({method:"addContactImportAddress"},a),a.importAddrCode&&a.importAddrName||this.onError({info:{errmsg:["An Import Address Code and Import Address Name must be provided."]}}),this.sendRequest(a,b)},BBCore.prototype.deleteContactImportAddress=function(a,b){a=$.extend({importAddrCode:1,method:"deleteContactImportAddress"},a),a.importAddrCode||this.onError({info:{errmsg:["Invalid Import Address Code"]}}),this.sendRequest(a,b)},BBCore.prototype.getClientRecentInteractions=function(a,b){a=a||{},a.activitySince=a.activitySince||"",a.method="GetClientRecentInteractions",this.sendRequest(a,b)},BBCore.prototype.getClientIntegrations=function(a){this.sendRequest({method:"getClientIntegrations"},a)},BBCore.prototype.sendCustomVideoEmail=function(a,b){var c={html_content:null,subject:"",email:"",email_id:"",from_name:""},d=$.extend({},c,a);this.sendRequest($.extend(d,{method:"SendCustomVideoEmail"}),b)},BBCore.prototype.ver=function(){return BBCore.CONFIG.VERSION};